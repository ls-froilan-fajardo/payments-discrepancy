<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CSV Filter Tables Side by Side</title>
<style>
body { 
  font-family: Arial, sans-serif; 
  padding: 20px; 
  background-color: #f4f4f4; 
  margin:0; 
}
h1,h2{ 
  margin-bottom: 10px; 
  font-size:16px; 
}

.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.flex-container { 
  display: flex; 
  width: 100%; 
  align-items: flex-start; 
}

.left-panel, .right-panel { 
  width: 50%; 
  padding: 0 10px; 
  box-sizing: border-box; 
  display:flex; 
  flex-direction: column; 
}

.controls { margin-bottom: 10px; font-size: 12px; }

/* Filters: fixed height for 4 items, scrollable if more */
.checkboxes {
  font-size: 12px;
  margin-bottom: 10px;
  max-height: calc(4 * 20px); 
  min-height: calc(4 * 20px); 
  overflow-y: auto;
}

.button-row {
  display: flex;
  gap: 5px;
  position: sticky;
  top: 0;
  z-index: 10;
  margin-bottom: 5px;
}
.button-row button {
  flex: 0 0 auto;
  margin-bottom: 0;
  background-color: #4CAF50;
  color:white;
  border:none;
  padding:5px 10px;
  font-size:10px;
  cursor:pointer;
}
.button-row button:hover { background-color: #45a049; }

.left-panel .table-container,
.right-panel .table-container {
  flex: 1;
  width: 100%;
  max-height: 400px;
  overflow-y: auto; 
  overflow-x: hidden;
}

table { 
  width: 100%; 
  border-collapse: collapse; 
  font-size:10px; 
  table-layout: fixed;
}
th, td { 
  border:1px solid #ccc; 
  padding:3px 5px; 
  text-align:left; 
  white-space: nowrap; 
  height:18px; 
}

.left-panel table th,
.right-panel table th { 
  position: sticky; 
  top:0; 
  background-color:#eee; 
  z-index:10; 
}

.left-panel table .totals-row,
.right-panel table .totals-row { 
  position: sticky; 
  bottom:0; 
  background-color:#ddd; 
  font-weight:bold; 
  z-index:9; 
}

tr.selected { outline:2px solid #4CAF50; cursor:pointer; }
label{ display:block; margin-bottom:2px; }
</style>
</head>
<body>

<div class="header-row">
  <h1>CSV Filter Tables Side by Side</h1>
  <h2 style="margin:0;">Second CSV Upload</h2>
</div>

<div class="flex-container">
  <!-- Left Panel -->
  <div class="left-panel">
    <div class="controls">
      <label><input type="radio" name="sortOptionLeft" value="date" checked /> Sort by Date</label>
      <label><input type="radio" name="sortOptionLeft" value="amount" /> Sort by Amount</label>
    </div>
    <input type="file" id="csvFileLeft" accept=".csv" />
    <div class="checkboxes" id="methodCheckboxesLeft"></div>

    <div class="button-row">
      <button id="addRowBtnLeft">Add Blank Row(s) Below Selected</button>
      <button id="removeRowBtnLeft">Remove Selected Row(s)</button>
      <button id="undoBtnLeft">Undo</button>
    </div>

    <div class="table-container" id="outputLeft"></div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel">
    <div class="controls">
      <label><input type="radio" name="sortOptionRight" value="date" checked /> Sort by Date</label>
      <label><input type="radio" name="sortOptionRight" value="amount" /> Sort by Paid</label>
    </div>
    <input type="file" id="csvFileRight" accept=".csv" />
    <div class="checkboxes" id="channelCheckboxesRight"></div>

    <div class="button-row">
      <button id="addRowBtnRight">Add Blank Row(s) Below Selected</button>
      <button id="removeRowBtnRight">Remove Selected Row(s)</button>
      <button id="undoBtnRight">Undo</button>
    </div>

    <div class="table-container" id="outputRight"></div>
  </div>
</div>

<script>
// ================= CSV Panel Initialization =================
function initCSVPanel(fileInputId, filterDivId, outputDivId, addBtnId, removeBtnId, undoBtnId, sortRadioName, isRight=false){
  let csvData = [];
  let headerRow = [];
  let selectedRows = new Set();
  let lastClickedRow = null;
  let actionHistory = [];
  let colPIndex, colQIndex, colHIndex, colFIndex, colMIndex, colNIndex, colOIndex, colPaymentIdIndex, colCardIndex;

  document.getElementById(fileInputId).addEventListener('change', function(event){
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => parseCSV(e.target.result);
    reader.readAsText(file);
  });

  document.querySelectorAll(`input[name="${sortRadioName}"]`).forEach(radio => radio.addEventListener('change', updateOutput));

  document.getElementById(addBtnId).addEventListener('click', addRows);
  document.getElementById(removeBtnId).addEventListener('click', removeRows);
  document.getElementById(undoBtnId).addEventListener('click', undoAction);

  function toggleRowSelection(tr,e){
    const allRows = Array.from(tr.parentNode.querySelectorAll('tr:not(.totals-row)'));
    if(e.shiftKey && lastClickedRow){
      const startIndex = allRows.indexOf(lastClickedRow);
      const endIndex = allRows.indexOf(tr);
      const [min,max] = [Math.min(startIndex,endIndex), Math.max(startIndex,endIndex)];
      for(let i=min;i<=max;i++){ allRows[i].classList.add('selected'); selectedRows.add(allRows[i]); }
    } else if(e.ctrlKey || e.metaKey){
      if(selectedRows.has(tr)){ tr.classList.remove('selected'); selectedRows.delete(tr); }
      else { tr.classList.add('selected'); selectedRows.add(tr); }
      lastClickedRow = tr;
    } else {
      selectedRows.forEach(r=>r.classList.remove('selected'));
      selectedRows.clear();
      tr.classList.add('selected');
      selectedRows.add(tr);
      lastClickedRow = tr;
    }
  }

  function parseCSV(text){
    const lines = text.trim().split('\n');
    headerRow = parseCSVLine(lines[0]);
    csvData = lines.slice(1).map(line => parseCSVLine(line));

    colQIndex = headerRow.indexOf("PaymentRef");
    colHIndex = headerRow.indexOf("Account");
    colFIndex = headerRow.indexOf("Date");
    colMIndex = headerRow.indexOf("Amount");
    colNIndex = headerRow.indexOf("Tip");
    colOIndex = headerRow.indexOf("Paid");
    colPaymentIdIndex = headerRow.indexOf("Payment ID");
    colCardIndex = headerRow.indexOf("Card last 4");

    updateOutput();
  }

  function parseCSVLine(line){
    const result=[];
    let current='', inQuotes=false;
    for(let i=0;i<line.length;i++){
      const char=line[i];
      if(char==='"' && line[i-1]!=='\\') inQuotes=!inQuotes;
      else if(char===',' && !inQuotes){ result.push(current); current=''; }
      else current+=char;
    }
    result.push(current);
    return result.map(c=>c.replace(/^"(.*)"$/,'$1'));
  }

  function parseCustomDate(dateStr){
    if(!dateStr) return null;
    let match = dateStr.match(/^(\d{2})\.(\d{2})\.(\d{2})\s+(\d{2}):(\d{2})$/);
    if(match){
        const [,dd,mm,yy,hh,min]=match;
        return new Date(2000+parseInt(yy), parseInt(mm)-1, parseInt(dd), parseInt(hh), parseInt(min));
    }
    match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/);
    if(match){
        const [ ,yyyy,mm,dd,hh,min,sec] = match;
        return new Date(parseInt(yyyy), parseInt(mm)-1, parseInt(dd), parseInt(hh), parseInt(min), parseInt(sec));
    }
    return new Date(dateStr);
  }

  function updateOutput(){
    selectedRows.clear();
    lastClickedRow=null;
    const outputDiv=document.getElementById(outputDivId);
    outputDiv.innerHTML='';

    let allRows=[];
    if(isRight){
        allRows = csvData.map(r=>{
            return {paymentRef: r[colPaymentIdIndex]||'', colH: r[colCardIndex]||'', colF: r[colFIndex]||'', totalM: parseFloat(r[colMIndex])||0, totalN: parseFloat(r[colNIndex])||0, totalO: parseFloat(r[colOIndex])||0};
        });
    } else {
        allRows = csvData.map(r=>{
            return {paymentRef:r[colQIndex]||'', colH:r[colHIndex]||'', colF:r[colFIndex]||'', totalM:parseFloat(r[colMIndex])||0, totalN:parseFloat(r[colNIndex])||0, totalO:parseFloat(r[colOIndex])||0};
        });
    }

    // Sorting
    const sortOption = document.querySelector(`input[name="${sortRadioName}"]:checked`).value;
    if(isRight){
        if(sortOption==='amount'){
            allRows.sort((a,b)=>b.totalO - a.totalO); // Paid
        } else {
            allRows.sort((a,b)=>parseCustomDate(a.colF) - parseCustomDate(b.colF)); // Date
        }
    } else {
        if(sortOption==='amount'){
            allRows.sort((a,b)=>b.totalM - a.totalM);
        } else {
            allRows.sort((a,b)=>parseCustomDate(a.colF) - parseCustomDate(b.colF));
        }
    }

    const table=document.createElement('table');
    let headers = ['PaymentRef','Account','Date','Amount','Tip','Paid'];
    table.innerHTML=`<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
    const tbody=document.createElement('tbody');

    allRows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.addEventListener('click',(e)=>toggleRowSelection(tr,e));
      headers.forEach(h=>{
        const td=document.createElement('td');
        if(h==='PaymentRef') td.textContent = r.paymentRef;
        else if(h==='Account') td.textContent = r.colH;
        else if(h==='Date') td.textContent = r.colF;
        else if(h==='Amount') td.textContent = r.totalM.toFixed(2);
        else if(h==='Tip') td.textContent = r.totalN.toFixed(2);
        else if(h==='Paid') td.textContent = r.totalO.toFixed(2);
        td.contentEditable=false;
        td.style.height='18px';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    const totalsRow=document.createElement('tr');
    totalsRow.classList.add('totals-row');
    const totalM=allRows.reduce((s,r)=>s+r.totalM,0);
    const totalN=allRows.reduce((s,r)=>s+r.totalN,0);
    const totalO=allRows.reduce((s,r)=>s+r.totalO,0);
    totalsRow.innerHTML='';
    ['Total','', '', totalM.toFixed(2), totalN.toFixed(2), totalO.toFixed(2)].forEach(val=>{
        const td=document.createElement('td');
        td.textContent=val;
        td.contentEditable=false;
        td.style.height='18px';
        totalsRow.appendChild(td);
    });
    tbody.appendChild(totalsRow);

    table.appendChild(tbody);
    outputDiv.appendChild(table);
  }

  function addRows(){
    const tableBody = document.querySelector(`#${outputDivId} table tbody`);
    if(!tableBody || selectedRows.size===0) return;
    const allRows = Array.from(tableBody.querySelectorAll('tr:not(.totals-row)'));
    let lastIndex = -1;
    allRows.forEach((tr,i)=>{ if(selectedRows.has(tr)) lastIndex=i; });
    const numRows = selectedRows.size;
    const addedRows = [];
    for(let i=0;i<numRows;i++){
      const tr=document.createElement('tr');
      const numCols = tableBody.rows[0].children.length;
      for(let c=0;c<numCols;c++){
        const td=document.createElement('td');
        td.textContent='';
        td.contentEditable=false;
        td.style.height='18px';
        tr.appendChild(td);
      }
      tr.addEventListener('click',(e)=>toggleRowSelection(tr,e));
      if(lastIndex>=0 && lastIndex<tableBody.rows.length-1){
        tableBody.insertBefore(tr, tableBody.rows[lastIndex+1]);
        lastIndex++;
      } else tableBody.appendChild(tr);
      addedRows.push(tr);
    }
    actionHistory.push({type:'add', rows:addedRows});
    updateOutput();
  }

  function removeRows(){
    const tableBody = document.querySelector(`#${outputDivId} table tbody`);
    if(!tableBody || selectedRows.size===0) return;
    const removedRows = [];
    selectedRows.forEach(tr=>{
      if(tr.parentNode) { removedRows.push({tr, nextSibling: tr.nextSibling}); tr.remove(); }
    });
    actionHistory.push({type:'remove', rows:removedRows});
    selectedRows.clear();
    updateOutput();
  }

  function undoAction(){
    if(actionHistory.length===0) return;
    const last = actionHistory.pop();
    if(last.type==='add'){
      last.rows.forEach(tr=>{
        if(tr.parentNode) tr.remove();
      });
    } else if(last.type==='remove'){
      last.rows.forEach(obj=>{
        if(obj.nextSibling) obj.nextSibling.parentNode.insertBefore(obj.tr,obj.nextSibling);
        else document.querySelector(`#${outputDivId} table tbody`).appendChild(obj.tr);
      });
    }
    updateOutput();
  }

}

initCSVPanel('csvFileLeft','methodCheckboxesLeft','outputLeft','addRowBtnLeft','removeRowBtnLeft','undoBtnLeft','sortOptionLeft', false);
initCSVPanel('csvFileRight','channelCheckboxesRight','outputRight','addRowBtnRight','removeRowBtnRight','undoBtnRight','sortOptionRight', true);
</script>

</body>
</html>
