<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CSV Column P Filter - Dynamic Columns</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; margin:0; }
  h1 { margin-bottom: 20px; font-size: 20px; }
  .flex-container { display: flex; width: 100vw; }
  .left-panel { width: 50vw; padding-right: 10px; box-sizing: border-box; }
  .controls { margin-bottom: 15px; font-size: 14px; }
  .checkboxes { margin-bottom: 20px; font-size: 14px; max-height: 200px; overflow-y: auto; }

  /* Sticky buttons */
  .sticky-btn {
    position: sticky;
    top: 0;
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 6px 12px;
    font-size: 12px;
    cursor: pointer;
    z-index: 10;
    margin-bottom: 5px;
    margin-right: 5px;
  }
  .sticky-btn:hover { background-color: #45a049; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 4px 6px;
    text-align: left;
    white-space: nowrap;
    height: 20px;
  }
  th {
    background-color: #eee;
    position: sticky;
    top: 36px; 
    z-index: 5;
  }
  tr.selected { outline: 2px solid #4CAF50; cursor: pointer; }
  tr.totals-row {
    font-weight: bold;
    background-color: #ddd;
    position: sticky;
    bottom: 0;
    z-index: 5;
  }
  label { display: block; margin-bottom: 4px; }
</style>
</head>
<body>

<h1>CSV Column P Filter</h1>

<div class="flex-container">
  <div class="left-panel">
    <div class="controls">
      <label><input type="radio" name="sortOption" value="date" checked /> Sort by Date</label>
      <label><input type="radio" name="sortOption" value="amount" /> Sort by Amount</label>
    </div>

    <input type="file" id="csvFile" accept=".csv" />
    <div class="checkboxes" id="methodCheckboxes"></div>

    <button id="addRowBtn" class="sticky-btn">Add Blank Row(s) Below Selected</button>
    <button id="removeRowBtn" class="sticky-btn">Remove Selected Row(s)</button>
    <button id="undoBtn" class="sticky-btn">Undo</button>

    <div id="output"></div>
  </div>

  <div class="right-panel" style="width:50vw; padding-left:10px;">
    <h2>Second CSV Upload (Coming Soon)</h2>
  </div>
</div>

<script>
let csvData = [];
let headerRow = [];
let selectedRows = new Set();
let lastClickedRow = null;

// Column indexes (dynamic)
let colPIndex, colQIndex, colHIndex, colFIndex, colMIndex, colNIndex, colOIndex;

// Undo stack
let actionHistory = [];

// CSV Upload
document.getElementById('csvFile').addEventListener('change', function(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => parseCSV(e.target.result);
  reader.readAsText(file);
});

// Sorting
document.querySelectorAll('input[name="sortOption"]').forEach(radio => radio.addEventListener('change', updateOutput));

// Add blank rows
document.getElementById('addRowBtn').addEventListener('click', function() {
  const tableBody = document.querySelector('#output table tbody');
  if(!tableBody || selectedRows.size===0) return;

  const allRows = Array.from(tableBody.querySelectorAll('tr:not(.totals-row)'));
  let lastIndex = -1;
  allRows.forEach((tr,i)=>{ if(selectedRows.has(tr)) lastIndex=i; });

  const numRows = selectedRows.size;
  const addedRows = [];
  for(let i=0;i<numRows;i++){
    const tr = document.createElement('tr');
    ['PaymentRef','ColH','ColF','TotalM','TotalN','TotalO'].forEach(_=>{
      const td=document.createElement('td');
      td.textContent='';
      td.contentEditable=false;
      td.style.height='20px';
      tr.appendChild(td);
    });
    tr.addEventListener('click',(e)=>toggleRowSelection(tr,e));
    if(lastIndex>=0 && lastIndex<tableBody.rows.length-1){
      tableBody.insertBefore(tr, tableBody.rows[lastIndex+1]);
      lastIndex++;
    } else tableBody.appendChild(tr);
    addedRows.push(tr);
  }
  updateTotals();
  actionHistory.push({type:'add', rows:addedRows});
});

// Remove selected
document.getElementById('removeRowBtn').addEventListener('click', function(){
  const removedRows = [];
  selectedRows.forEach(tr=>{ 
    if(tr.parentNode){
      removedRows.push({row:tr, nextSibling:tr.nextSibling});
      tr.parentNode.removeChild(tr);
    } 
  });
  selectedRows.clear();
  lastClickedRow=null;
  updateTotals();

  if(removedRows.length>0){
    actionHistory.push({type:'delete', rows:removedRows});
  }
});

// Undo button
document.getElementById('undoBtn').addEventListener('click', function(){
  if(actionHistory.length===0) return;
  const lastAction = actionHistory.pop();
  const tableBody = document.querySelector('#output table tbody');
  if(!tableBody) return;

  if(lastAction.type==='add'){
    lastAction.rows.forEach(tr=>{
      if(tr.parentNode) tr.parentNode.removeChild(tr);
    });
  } else if(lastAction.type==='delete'){
    lastAction.rows.forEach(obj=>{
      const {row, nextSibling} = obj;
      if(nextSibling && nextSibling.parentNode){
        tableBody.insertBefore(row, nextSibling);
      } else {
        tableBody.appendChild(row);
      }
    });
  }
  updateTotals();
});

// Row selection
function toggleRowSelection(tr,e){
  const allRows = Array.from(tr.parentNode.querySelectorAll('tr:not(.totals-row)'));
  if(e.shiftKey && lastClickedRow){
    const startIndex = allRows.indexOf(lastClickedRow);
    const endIndex = allRows.indexOf(tr);
    const [min,max] = [Math.min(startIndex,endIndex), Math.max(startIndex,endIndex)];
    for(let i=min;i<=max;i++){ allRows[i].classList.add('selected'); selectedRows.add(allRows[i]); }
  } else if(e.ctrlKey || e.metaKey){
    if(selectedRows.has(tr)){ tr.classList.remove('selected'); selectedRows.delete(tr); }
    else { tr.classList.add('selected'); selectedRows.add(tr); }
    lastClickedRow = tr;
  } else {
    selectedRows.forEach(r=>r.classList.remove('selected'));
    selectedRows.clear();
    tr.classList.add('selected');
    selectedRows.add(tr);
    lastClickedRow = tr;
  }
}

// CSV Parsing
function parseCSV(text){
  const lines = text.trim().split('\n');
  headerRow = parseCSVLine(lines[0]);
  csvData = lines.slice(1).map(line => parseCSVLine(line));

  // Set dynamic column indexes
  colPIndex = headerRow.indexOf("Method");
  colQIndex = headerRow.indexOf("PaymentRef");
  colHIndex = headerRow.indexOf("Account"); // <- updated
  colFIndex = headerRow.indexOf("Date");
  colMIndex = headerRow.indexOf("Amount");
  colNIndex = headerRow.indexOf("Tip");
  colOIndex = headerRow.indexOf("Paid");

  generateCheckboxes();
}

function parseCSVLine(line){
  const result=[];
  let current='', inQuotes=false;
  for(let i=0;i<line.length;i++){
    const char=line[i];
    if(char==='"' && line[i-1]!=='\\') inQuotes=!inQuotes;
    else if(char===',' && !inQuotes){ result.push(current); current=''; }
    else current+=char;
  }
  result.push(current);
  return result.map(c=>c.replace(/^"(.*)"$/,'$1'));
}

function cleanMethod(method){ return method? method.replace(/\s*\(.*?\)\s*/g,'').trim() : ''; }

function parseCustomDate(dateStr){
  if(!dateStr) return null;
  const match=dateStr.match(/^(\d{2})\.(\d{2})\.(\d{2})\s+(\d{2}):(\d{2})$/);
  if(!match) return null;
  const [,dd,mm,yy,hh,min]=match;
  return new Date(2000+parseInt(yy), parseInt(mm)-1, parseInt(dd), parseInt(hh), parseInt(min));
}

function generateCheckboxes(){
  const div = document.getElementById('methodCheckboxes');
  div.innerHTML='';
  const methods = [...new Set(csvData.map(r=>cleanMethod(r[colPIndex])).filter(m=>m!=''))].sort();
  methods.forEach(method=>{
    const label = document.createElement('label');
    const checkbox = document.createElement('input');
    checkbox.type='checkbox';
    checkbox.value=method;
    checkbox.addEventListener('change', updateOutput);
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(' '+method));
    div.appendChild(label);
  });
}

function updateOutput(){
  selectedRows.clear();
  lastClickedRow=null;
  const outputDiv = document.getElementById('output');
  outputDiv.innerHTML='';
  const checkedMethods = Array.from(document.querySelectorAll('#methodCheckboxes input:checked')).map(cb=>cb.value);
  if(checkedMethods.length===0){ outputDiv.innerHTML='<i>No method selected</i>'; return; }

  const allRows=[];
  checkedMethods.forEach(method=>{
    const rows = csvData.filter(r=>cleanMethod(r[colPIndex])===method);
    const standaloneRows = rows.filter(r=>!r[colQIndex]);
    const nonBlankRows = rows.filter(r=>r[colQIndex]);

    standaloneRows.forEach(r=>{
      allRows.push({paymentRef:'Standalone', colH:r[colHIndex]||'', colF:r[colFIndex]||'', totalM:parseFloat(r[colMIndex])||0, totalN:parseFloat(r[colNIndex])||0, totalO:parseFloat(r[colOIndex])||0});
    });

    const grouped={};
    nonBlankRows.forEach(r=>{
      const key=r[colQIndex]; if(!grouped[key]) grouped[key]=[]; grouped[key].push(r);
    });

    Object.keys(grouped).forEach(paymentRef=>{
      const g=grouped[paymentRef];
      const totalM=g.reduce((s,r)=>s+(parseFloat(r[colMIndex])||0),0);
      const totalN=g.reduce((s,r)=>s+(parseFloat(r[colNIndex])||0),0);
      const totalO=g.reduce((s,r)=>s+(parseFloat(r[colOIndex])||0),0);
      allRows.push({paymentRef, colH:g[0][colHIndex]||'', colF:g[0][colFIndex]||'', totalM,totalN,totalO});
    });
  });

  const sortOption = document.querySelector('input[name="sortOption"]:checked').value;
  if(sortOption==='amount'){ 
    allRows.sort((a,b)=>parseFloat(b.totalO)-parseFloat(a.totalO)); 
  } else if(sortOption==='date'){ 
    allRows.sort((a,b)=>{
      const dateA=parseCustomDate(a.colF);
      const dateB=parseCustomDate(b.colF);
      if(!dateA && !dateB) return 0;
      if(!dateA) return 1;
      if(!dateB) return -1;
      return dateA-dateB;
    });
  }

  const table = document.createElement('table');
  table.innerHTML=`<thead>
  <tr><th>PaymentRef (Q)</th><th>Account</th><th>Date</th><th>Amount</th><th>Tip</th><th>Paid</th></tr>
  </thead>`;
  const tbody=document.createElement('tbody');

  allRows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.addEventListener('click',(e)=>toggleRowSelection(tr,e));
    [r.paymentRef,r.colH,r.colF,r.totalM.toFixed(2),r.totalN.toFixed(2),r.totalO.toFixed(2)].forEach(val=>{
      const td=document.createElement('td');
      td.textContent=val;
      td.contentEditable=false;
      td.style.height='20px';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  const totalsRow = document.createElement('tr');
  totalsRow.classList.add('totals-row');
  updateTotalsRow(totalsRow, tbody);
  tbody.appendChild(totalsRow);

  table.appendChild(tbody);
  outputDiv.appendChild(table);
}

function updateTotals(){
  const tableBody = document.querySelector('#output table tbody');
  if(!tableBody) return;
  const totalsRow = tableBody.querySelector('.totals-row');
  if(!totalsRow) return;
  updateTotalsRow(totalsRow, tableBody);
}

function updateTotalsRow(totalsRow, tbody){
  const rows = Array.from(tbody.querySelectorAll('tr:not(.totals-row)'));
  const totalM = rows.reduce((s,r)=>s+(parseFloat(r.children[3].textContent)||0),0);
  const totalN = rows.reduce((s,r)=>s+(parseFloat(r.children[4].textContent)||0),0);
  const totalO = rows.reduce((s,r)=>s+(parseFloat(r.children[5].textContent)||0),0);
  totalsRow.innerHTML = '';
  ['Total','', '', totalM.toFixed(2), totalN.toFixed(2), totalO.toFixed(2)].forEach(val=>{
    const td = document.createElement('td');
    td.textContent = val;
    td.contentEditable = false;
    td.style.height='20px';
    totalsRow.appendChild(td);
  });
}
</script>

</body>
</html>
